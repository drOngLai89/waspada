import Constants from 'expo-constants';

type ReportPayload = {
  category: string;
  dateISO: string;       // date the user picked (local -> you built this)
  timeISO: string;       // time the user picked (local -> you built this)
  locationText: string;
  description: string;
};

function getFromExtra(key: string): string | undefined {
  const cfg: any = (Constants as any).expoConfig || (Constants as any).manifest || {};
  return cfg?.extra?.[key];
}

const BASE = (getFromExtra('API_BASE_URL') || process.env.API_BASE_URL || '').trim();
const REPORT_PATH = (getFromExtra('REPORT_PATH') || process.env.REPORT_PATH || '/report').trim();
const CHAT_PATH   = (getFromExtra('CHAT_PATH')   || process.env.CHAT_PATH   || '/chat').trim();

console.log('API_BASE_URL ⇒', BASE || '(not set)');

function full(base: string, path: string) {
  const b = base.replace(/\/+$/,'');
  const p = path.startsWith('/') ? path : `/${path}`;
  return `${b}${p}`;
}

async function tryPostJSON<T>(url: string, body: any): Promise<T> {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(`HTTP ${res.status} at ${url}`);
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await res.json();
  const text = await res.text();
  return { reply: text } as unknown as T;
}

/** Merge a local date + local time into one local Date */
function combineLocal(dateOnly: Date, timeOnly: Date) {
  const d = new Date(dateOnly);
  d.setHours(timeOnly.getHours(), timeOnly.getMinutes(), timeOnly.getSeconds(), 0);
  return d;
}

/** Build local-time metadata we can send to backend (harmless if ignored) */
function buildLocalTimeMeta(dateISO: string | undefined, timeISO: string | undefined) {
  let incidentAt = new Date();
  if (dateISO && timeISO) incidentAt = combineLocal(new Date(dateISO), new Date(timeISO));
  const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
  const tzOffsetMinutes = -incidentAt.getTimezoneOffset();
  const incidentAtText = `${incidentAt.toLocaleString()} (${tzName})`;
  const incidentAtISO = incidentAt.toISOString(); // UTC, machine-friendly
  return { incidentAt, incidentAtText, incidentAtISO, tzName, tzOffsetMinutes };
}

export async function generateReport(payload: ReportPayload): Promise<{report:string}> {
  // Build local time info from the user's picked date/time (no server change needed)
  const { incidentAtText, incidentAtISO, tzName, tzOffsetMinutes } =
    buildLocalTimeMeta(payload.dateISO, payload.timeISO);

  // Send a gentle, explicit note in description so the model uses the exact local time
  const descHint =
    `\n\n[Note for summarization: Incident time (local, do not convert): ${incidentAtText}]`;
  const descForModel =
    payload.description?.includes('Incident time (local') ? payload.description : (payload.description + descHint);

  // Body we send to the backend (keeps original fields for compatibility +
  // includes extra fields most servers will simply ignore if unknown)
  const sendBody: any = {
    ...payload,
    description: descForModel,
    incidentAtISO,
    incidentAtText,
    tzOffsetMinutes,
    tzName,
  };

  if (BASE) {
    const candidates = [
      REPORT_PATH, '/api/report', '/v1/report', '/generate', '/api/generate'
    ];
    for (const path of candidates) {
      try {
        const data: any = await tryPostJSON(full(BASE, path), sendBody);
        const text = data.report ?? data.summary ?? data.text ?? data.message;
        if (text) return { report: String(text) };
      } catch (e) {
        console.log('Endpoint failed →', path, String(e));
      }
    }
  }

  // offline fallback
  const fallback =
`**Incident Report for Berani App**

**Category**
- ${payload.category}

**Description of the Incident**
On ${incidentAtText}, a user reported: ${payload.description || 'No description provided.'}

**Location**
- ${payload.locationText || 'Not specified'}

**Impact**
- The incident may affect feelings of safety and wellbeing.
- Reported behavior can cause stress, anxiety, or fear.

**Next Steps**
- Encourage the user to document details and preserve evidence.
- If safe, consider reporting to authorities or trusted contacts.
- Use the Berani app resources for guidance and support.

**Safety Resources (Malaysia)**
- Emergency: 999
- Talian Kasih 15999 (WhatsApp 019-2615999)`;
  return { report: fallback };
}

export async function sendCounsellorMessage(
  messages: { role:'user'|'assistant'|'system'; content:string }[]
): Promise<{ reply: string }> {
  if (BASE) {
    const candidates = [CHAT_PATH, '/api/chat', '/v1/chat', '/messages', '/api/messages', '/respond'];
    for (const path of candidates) {
      try {
        const data: any = await tryPostJSON(full(BASE, path), { messages });
        const text = data.reply ?? data.text ?? data.message;
        if (text) return { reply: String(text) };
      } catch (e) { console.log('Endpoint failed →', path, String(e)); }
    }
  }
  // fallback reply (keeps UX working)
  return {
    reply:
`I'm here with you. If you’re in immediate danger, call **999** now.

24/7 Malaysia helplines:
• **Talian Kasih 15999** (WhatsApp **019-2615999**)
• **Befrienders** **03-7627 2929**
• **WAO Hotline** **+603-7956 3488** (WhatsApp **+6018-988 8058**)`
  };
}
